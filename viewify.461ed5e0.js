function _array_like_to_array(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function _array_with_holes(e){if(Array.isArray(e))return e}function _array_without_holes(e){if(Array.isArray(e))return _array_like_to_array(e)}function asyncGeneratorStep(e,t,r,n,o,a,c){try{var s=e[a](c),i=s.value}catch(e){r(e);return}s.done?t(i):Promise.resolve(i).then(n,o)}function _async_to_generator(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function c(e){asyncGeneratorStep(a,n,o,c,s,"next",e)}function s(e){asyncGeneratorStep(a,n,o,c,s,"throw",e)}c(void 0)})}}function _define_property(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _iterable_to_array(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _iterable_to_array_limit(e,t){var r,n,o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var a=[],c=!0,s=!1;try{for(o=o.call(e);!(c=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);c=!0);}catch(e){s=!0,n=e}finally{try{c||null==o.return||o.return()}finally{if(s)throw n}}return a}}function _non_iterable_rest(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _non_iterable_spread(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _object_spread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){_define_property(e,t,r[t])})}return e}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function _object_spread_props(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function _sliced_to_array(e,t){return _array_with_holes(e)||_iterable_to_array_limit(e,t)||_unsupported_iterable_to_array(e,t)||_non_iterable_rest()}function _to_consumable_array(e){return _array_without_holes(e)||_iterable_to_array(e)||_unsupported_iterable_to_array(e)||_non_iterable_spread()}function _unsupported_iterable_to_array(e,t){if(e){if("string"==typeof e)return _array_like_to_array(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _array_like_to_array(e,t)}}function _ts_generator(e,t){var r,n,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=s(0),c.throw=s(1),c.return=s(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function s(s){return function(i){var l=[s,i];if(r)throw TypeError("Generator is already executing.");for(;c&&(c=0,l[0]&&(a=0)),a;)try{if(r=1,n&&(o=2&l[0]?n.return:l[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,l[1])).done)return o;switch(n=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,n=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===l[0]||2===l[0])){a=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){a.label=l[1];break}if(6===l[0]&&a.label<o[1]){a.label=o[1],o=l;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(l);break}o[2]&&a.ops.pop(),a.trys.pop();continue}l=t.call(e,a)}catch(e){l=[6,e],n=0}finally{r=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}}var album_cover,progress,duration,time_left,last_track_id,track_id,track_name,lyrics,last_fetched_time,currently_paused,timerID_fetch,paused=!0,urlParams=new URLSearchParams(window.location.search),code=urlParams.get("code"),clientId=localStorage.getItem("client_id"),redirectUri="http://127.0.0.1:5500/src/index.html";clientId||console.warn("clientId not found in localStorage. Make sure auth.js set it before redirect.");var getToken=function(e){return _async_to_generator(function(){var t,r,n,o;return _ts_generator(this,function(a){switch(a.label){case 0:if(a.trys.push([0,3,,4]),!(t=localStorage.getItem("code_verifier")))throw Error("code_verifier missing from localStorage");return[4,fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:new URLSearchParams({client_id:clientId,grant_type:"authorization_code",code:e,redirect_uri:redirectUri,code_verifier:t})})];case 1:return[4,(r=a.sent()).json()];case 2:if(console.log("token endpoint response:",n=a.sent()),!r.ok)throw Error(`Token endpoint returned ${r.status}: ${JSON.stringify(n)}`);if(!n.access_token)throw Error(`No access_token in token response: ${JSON.stringify(n)}`);return localStorage.setItem("access_token",n.access_token),n.refresh_token&&localStorage.setItem("refresh_token",n.refresh_token),window.history.replaceState({},document.title,window.location.pathname),console.log("Access token saved to localStorage."),[2,n.access_token];case 3:console.error("getToken error:",o=a.sent());try{window.history.replaceState({},document.title,window.location.pathname)}catch(e){console.warn("Could not clean URL:",e)}if(o&&o.message&&o.message.includes("code_verifier")){console.warn("code_verifier missing — restarting auth flow in this tab.");try{auth()}catch(e){console.error("Failed to restart auth:",e)}return[2]}throw o;case 4:return[2]}})})()};function getCurrentPlayer(){return _async_to_generator(function(){return _ts_generator(this,function(e){return[2,fetchWrapper("https://api.spotify.com/v1/me/player")]})})()}function fetchData(){console.log("fetched data"),getCurrentPlayer().then(function(e){console.log(e),album_cover=e.item.album.images[0].url,document.getElementById("img").src=album_cover,progress=e.progress_ms,last_fetched_time=Date.now(),time_left=(duration=e.item.duration_ms)-progress,clearTimeout(timerID_fetch),timerID_fetch=setTimeout(fetchData,time_left+5),last_track_id=e.item.id,track_name=e.item.name,document.getElementById("trackName").innerText=track_name,e.actions.disallows.pausing&&!paused&&(document.getElementById("play").innerHTML='<span class="material-symbols-outlined">play_arrow</span>',document.getElementById("play").onclick=resume,paused=!0),e.actions.disallows.resuming&&paused&&(document.getElementById("play").innerHTML='<span class="material-symbols-outlined">pause</span>',document.getElementById("play").onclick=pause,paused=!1),getLyrics(e.item.artists[0].name,track_name,e.item.album.name,Math.floor(duration/1e3)).then(function(e){if(!e||0===e.length){document.getElementById("lyricsDiv").innerHTML="<p>No lyrics available</p>",lyrics=[];return}lyrics=e.split("\n").map(function(e){var t=e.match(/\[(\d+):(\d+\.\d+)\]\s*(.*)/);return t?{time:60*parseInt(t[1],10)+parseFloat(t[2]),text:t[3]}:null}).filter(Boolean);var t=document.getElementById("lyricsDiv");t.innerHTML="",lyrics.forEach(function(e,r){var n=document.createElement("p");n.classList.add("line"),n.textContent=e.text||"",t.appendChild(n),e.el=n}),startLyricSync()})}).catch(function(e){return console.error(e)})}function startLyricSync(){setInterval(function(){if(lyrics&&0!==lyrics.length&&!paused){for(var e=Math.floor((progress+(Date.now()-last_fetched_time))/1e3),t=-1,r=0;r<lyrics.length;r++)if(e>=lyrics[r].time)t=r;else break;lyrics.forEach(function(e,r){e.el.classList.remove("active","faded"),r===t?e.el.classList.add("active"):(r===t-1||r===t+1)&&e.el.classList.add("faded")}),-1!==t&&lyrics[t].el.scrollIntoView({behavior:"smooth",block:"center"})}},50)}function checkTimestamp(){return _async_to_generator(function(){return _ts_generator(this,function(e){switch(e.label){case 0:return[4,getCurrentPlayer().then(function(e){var t;track_id=e.item.id,currently_paused=null!=(t=e.actions.disallows.pausing)&&t})];case 1:return e.sent(),console.log("checked timestamp"),(track_id!=last_track_id||paused!=currently_paused)&&fetchData(),setTimeout(checkTimestamp,3e3),[2]}})})()}function getLyrics(e,t,r,n){return _async_to_generator(function(){var o,a,c;return _ts_generator(this,function(s){switch(s.label){case 0:o=`https://lrclib.net/api/get?artist_name=${encodeURIComponent(e)}&track_name=${encodeURIComponent(t)}&album_name=${encodeURIComponent(r)}&duration=${n}`,s.label=1;case 1:return s.trys.push([1,6,,7]),[4,fetch(o)];case 2:if((a=s.sent()).ok)return[3,4];return[4,a.text()];case 3:throw s.sent(),Error(`Lyrics API error ${a.status}: ${text}`);case 4:return[4,a.json()];case 5:if(!(c=s.sent()).syncedLyrics||""===c.syncedLyrics.trim())return console.warn(`No lyrics found for ${e} - ${t}`),[2,[]];return[2,c.syncedLyrics];case 6:return console.error("Error fetching lyrics:",s.sent()),[2,[]];case 7:return[2]}})})()}function showLyrics(){document.getElementById("albumDiv").style.display="none",document.getElementById("detailsDiv").style.display="flex"}function showCover(){document.getElementById("albumDiv").style.display="flex",document.getElementById("detailsDiv").style.display="none"}function pause(){return _async_to_generator(function(){return _ts_generator(this,function(e){switch(e.label){case 0:return[4,fetchWrapper("https://api.spotify.com/v1/me/player/pause",{method:"PUT"})];case 1:return e.sent(),fetchData(),[2]}})})()}function resume(){console.log("tried to resume")}function next(){return _async_to_generator(function(){return _ts_generator(this,function(e){switch(e.label){case 0:return[4,fetchWrapper("https://api.spotify.com/v1/me/player/next",{method:"POST"})];case 1:return e.sent(),fetchData(),[2]}})})()}function previous(){return _async_to_generator(function(){return _ts_generator(this,function(e){switch(e.label){case 0:return[4,fetchWrapper("https://api.spotify.com/v1/me/player/previous",{method:"POST"})];case 1:return e.sent(),fetchData(),[2]}})})()}document.addEventListener("DOMContentLoaded",function(){var e=function(){try{var e=o.getPalette(t,2),a=_sliced_to_array(e.map(function(e){return`rgb(${e.join(",")})`}),2),c=a[0],s=a[1];r.style.background=`linear-gradient(135deg, ${c}, ${s})`,n.style.background=`linear-gradient(135deg, ${c}, ${s})`}catch(e){console.warn("Could not extract colors:",e)}},t=document.getElementById("img"),r=document.getElementById("albumDiv"),n=document.getElementById("detailsDiv"),o=new ColorThief;t.addEventListener("load",e),t.complete&&e()});var refreshToken=function(){return _async_to_generator(function(){var e,t,r;return _ts_generator(this,function(n){switch(n.label){case 0:if(!(e=localStorage.getItem("refresh_token")))throw Error("No refresh token available");return[4,fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e,client_id:localStorage.getItem("client_id")})})];case 1:return[4,(t=n.sent()).json()];case 2:if(r=n.sent(),!t.ok)throw Error(`Refresh token failed: ${JSON.stringify(r)}`);return localStorage.setItem("access_token",r.access_token),r.refresh_token&&localStorage.setItem("refresh_token",r.refresh_token),console.log("Access token refreshed"),[2,r.access_token]}})})()};function fetchWrapper(e){return _async_to_generator(function(e){var t,r,n,o,a,c=arguments;return _ts_generator(this,function(s){switch(s.label){case 0:return t=c.length>1&&void 0!==c[1]?c[1]:{},r=!(c.length>2)||void 0===c[2]||c[2],n=localStorage.getItem("access_token"),[4,fetch(e,_object_spread_props(_object_spread({},t),{headers:_object_spread({Authorization:`Bearer ${n}`,Accept:"application/json"},t.headers||{})}))];case 1:if(!(401===(o=s.sent()).status&&r))return[3,3];return console.log("Access token expired, refreshing..."),[4,refreshToken()];case 2:return s.sent(),[2,fetchWrapper(e,t,!1)];case 3:if(!(!o.ok&&204!==o.status))return[3,5];return[4,o.text()];case 4:throw a=s.sent(),Error(`Spotify API error ${o.status}: ${a}`);case 5:if(204===o.status)return[2,null];return[4,o.json()];case 6:return[2,s.sent()]}})}).apply(this,arguments)}function init(){return _async_to_generator(function(){var e;return _ts_generator(this,function(t){switch(t.label){case 0:if(e=new URLSearchParams(window.location.search).get("code"),localStorage.getItem("access_token"),!e)return[3,4];t.label=1;case 1:return t.trys.push([1,3,,4]),[4,getToken(e)];case 2:return t.sent(),window.history.replaceState({},document.title,window.location.pathname),[3,4];case 3:return console.error("Token exchange failed:",t.sent()),[2];case 4:if(!localStorage.getItem("access_token"))return console.log("No token found, starting auth flow…"),auth(),[2];return fetchData(),checkTimestamp(),[2]}})})()}function auth(){return _async_to_generator(function(){var e,t,r,n,o,a;return _ts_generator(this,function(c){switch(c.label){case 0:var s;return e=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return crypto.getRandomValues(new Uint8Array(e)).reduce(function(e,r){return e+t[r%t.length]},"")},t=function(e){var t;return btoa((t=String).fromCharCode.apply(t,_to_consumable_array(new Uint8Array(e)))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},[4,(s=r=e(64),_async_to_generator(function(){var e;return _ts_generator(this,function(t){return e=new TextEncoder().encode(s),[2,window.crypto.subtle.digest("SHA-256",e)]})})())];case 1:return n=c.sent(),o=t(n),a=new URL("https://accounts.spotify.com/authorize"),window.localStorage.setItem("code_verifier",r),window.localStorage.setItem("client_id","2ec4eeb99cc94764b7dd30b898d7e3b1"),a.search=new URLSearchParams({response_type:"code",client_id:"2ec4eeb99cc94764b7dd30b898d7e3b1",scope:"user-read-private user-read-email user-read-playback-state user-modify-playback-state",code_challenge_method:"S256",code_challenge:o,redirect_uri:"http://127.0.0.1:5500/src/index.html"}).toString(),window.location.href=a.toString(),[2]}})})()}init(),window.runAuth=auth;
//# sourceMappingURL=viewify.461ed5e0.js.map
